<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AREX Integrated Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px 15px 0 0;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #1a237e;
            margin-bottom: 0.5rem;
        }
        
        .status-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .status-item {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-dot.connected { background: #4CAF50; }
        .status-dot.pending { background: #FF9800; }
        .status-dot.error { background: #F44336; }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a237e;
        }
        
        .refresh-btn {
            background: #1a237e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .refresh-btn:hover {
            background: #283593;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a237e;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .function-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .function-status.connected { border-color: #4CAF50; }
        .function-status.pending { border-color: #FF9800; }
        .function-status.error { border-color: #F44336; }
        
        .log {
            font-family: monospace;
            font-size: 12px;
            background: #282c34;
            color: #abb2bf;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 0.25rem 0;
        }
        
        .log-success { color: #4CAF50; }
        .log-error { color: #F44336; }
        .log-info { color: #2196F3; }
        
        .api-test {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .api-btn {
            flex: 1;
            background: #e3f2fd;
            color: #1565c0;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .api-btn:hover {
            background: #bbdefb;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üöÄ AREX Integrated Dashboard</h1>
            <p>Connected to real Firebase Cloud Functions</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="api-status"></div>
                    <span id="api-status-text">API Status</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="health-status"></div>
                    <span id="health-status-text">Health Check</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="functions-status"></div>
                    <span id="functions-status-text">Functions</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- Financial Data Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí∞ Financial Overview</div>
                    <button class="refresh-btn" onclick="loadFinancialData()">
                        Refresh
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-revenue">KES 0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-payments">KES 0</div>
                        <div class="stat-label">Total Payments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="active-agents">0</div>
                        <div class="stat-label">Active Agents</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pending-commissions">KES 0</div>
                        <div class="stat-label">Pending Commissions</div>
                    </div>
                </div>
                
                <div class="api-test">
                    <button class="api-btn" onclick="testFinancialApi()">
                        Test Financial API
                    </button>
                    <button class="api-btn" onclick="testAgentPayments()">
                        Test Agent Payments
                    </button>
                </div>
            </div>
            
            <!-- Function Status Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîå Function Status</div>
                    <button class="refresh-btn" onclick="checkFunctionStatus()">
                        Check
                    </button>
                </div>
                
                <div id="function-list">
                    <div class="function-status pending">
                        <span>Loading functions...</span>
                        <span>‚óè</span>
                    </div>
                </div>
                
                <div class="log" id="function-log">
                    <!-- Function logs will appear here -->
                </div>
            </div>
            
            <!-- API Testing Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üß™ API Testing</div>
                </div>
                
                <div class="api-test">
                    <button class="api-btn" onclick="testLogin()">
                        Test Login
                    </button>
                    <button class="api-btn" onclick="testHealth()">
                        Test Health
                    </button>
                    <button class="api-btn" onclick="testPlatformStats()">
                        Test Platform Stats
                    </button>
                </div>
                
                <div class="log" id="test-log">
                    <!-- Test logs will appear here -->
                </div>
            </div>
            
            <!-- Agent Payments Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üë• Agent Payments</div>
                    <button class="refresh-btn" onclick="loadAgentPayments()">
                        Load
                    </button>
                </div>
                
                <div id="agent-payments">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        Click "Load" to fetch agent payment data
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load the real API -->
    <script src="/js/arex-api-config.js"></script>
    <script src="/js/arex-real-api.js"></script>
    
    <script>
        // Initialize API
        let arexAPI = null;
        
        // Logging functions
        function logFunction(message) {
            const logDiv = document.getElementById('function-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="log-entry log-info">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function logTest(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `log-${type}`;
            logDiv.innerHTML += `<div class="log-entry ${typeClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Dashboard initialized');
            
            // Check if API is loaded
            if (window.arexRealAPI) {
                arexAPI = window.arexRealAPI;
                console.log('‚úÖ AREX Real API loaded');
                
                // Update API status
                updateStatus('api-status', 'connected', 'API Ready');
                
                // Test connection
                await testConnection();
            } else {
                console.error('‚ùå AREX Real API not loaded');
                updateStatus('api-status', 'error', 'API Not Loaded');
            }
        });
        
        // Update status indicator
        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            const textElement = document.getElementById(elementId + '-text');
            
            if (element && textElement) {
                element.className = 'status-dot ' + status;
                textElement.textContent = text;
            }
        }
        
        // Test connection to backend
        async function testConnection() {
            logTest('Testing backend connection...', 'info');
            updateStatus('health-status', 'pending', 'Testing...');
            
            try {
                const result = await arexAPI.getHealth();
                
                if (result.success) {
                    logTest('‚úÖ Health check passed', 'success');
                    updateStatus('health-status', 'connected', 'Healthy');
                    
                    // Load initial data
                    loadFinancialData();
                    checkFunctionStatus();
                } else {
                    logTest(`‚ùå Health check failed: ${result.error}`, 'error');
                    updateStatus('health-status', 'error', 'Failed');
                }
            } catch (error) {
                logTest(`‚ùå Connection error: ${error.message}`, 'error');
                updateStatus('health-status', 'error', 'Error');
            }
        }
        
        // Load financial data
        async function loadFinancialData() {
            logTest('Loading financial data...', 'info');
            
            try {
                const financial = await arexAPI.getFinancialSummary();
                
                if (financial.success) {
                    // Update UI
                    document.getElementById('total-revenue').textContent = 
                        'KES ' + (financial.totalRevenue || 0).toLocaleString('en-KE');
                    document.getElementById('total-payments').textContent = 
                        'KES ' + (financial.totalPayments || 0).toLocaleString('en-KE');
                    document.getElementById('active-agents').textContent = 
                        financial.activeAgents || 0;
                    document.getElementById('pending-commissions').textContent = 
                        'KES ' + (financial.pendingCommissions || 0).toLocaleString('en-KE');
                    
                    logTest('‚úÖ Financial data loaded', 'success');
                } else {
                    logTest(`‚ùå Financial data error: ${financial.error}`, 'error');
                }
            } catch (error) {
                logTest(`‚ùå Financial data error: ${error.message}`, 'error');
            }
        }
        
        // Check function status
        async function checkFunctionStatus() {
            logFunction('Checking function status...');
            
            const functions = [
                'api',
                'financialApi',
                'login',
                'simpleHealth',
                'getAgentPaymentSummary'
            ];
            
            const listDiv = document.getElementById('function-list');
            listDiv.innerHTML = '';
            
            for (const funcName of functions) {
                const func = arexApiConfig.getAvailableFunctions().find(f => f.name === funcName);
                if (!func) continue;
                
                // Create status element
                const statusEl = document.createElement('div');
                statusEl.className = 'function-status pending';
                statusEl.innerHTML = `
                    <span>${func.name}</span>
                    <span>‚óè</span>
                `;
                listDiv.appendChild(statusEl);
                
                // Test the function
                try {
                    const response = await fetch(func.url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        statusEl.className = 'function-status connected';
                        logFunction(`‚úÖ ${func.name}: Connected`);
                    } else {
                        statusEl.className = 'function-status error';
                        logFunction(`‚ùå ${func.name}: HTTP ${response.status}`);
                    }
                } catch (error) {
                    statusEl.className = 'function-status error';
                    logFunction(`‚ùå ${func.name}: ${error.message}`);
                }
            }
            
            // Update overall status
            const connected = document.querySelectorAll('.function-status.connected').length;
            const total = functions.length;
            updateStatus('functions-status', connected === total ? 'connected' : 'pending', 
                       `${connected}/${total} Connected`);
        }
        
        // Test functions
        async function testFinancialApi() {
            logTest('Testing Financial API...', 'info');
            
            try {
                const result = await arexAPI.getFinancialSummary();
                logTest(`Financial API result: ${JSON.stringify(result).substring(0, 100)}...`, 
                       result.success ? 'success' : 'error');
            } catch (error) {
                logTest(`Financial API error: ${error.message}`, 'error');
            }
        }
        
        async function testAgentPayments() {
            logTest('Testing Agent Payments API...', 'info');
            
            try {
                const result = await arexAPI.getAgentPaymentSummary();
                logTest(`Agent Payments: ${JSON.stringify(result).substring(0, 100)}...`,
                       result.success ? 'success' : 'error');
            } catch (error) {
                logTest(`Agent Payments error: ${error.message}`, 'error');
            }
        }
        
        async function testHealth() {
            logTest('Testing Health endpoint...', 'info');
            
            try {
                const result = await arexAPI.getHealth();
                logTest(`Health: ${JSON.stringify(result)}`, 
                       result.success ? 'success' : 'error');
            } catch (error) {
                logTest(`Health error: ${error.message}`, 'error');
            }
        }
        
        async function testPlatformStats() {
            logTest('Testing Platform Stats...', 'info');
            
            try {
                const result = await arexAPI.getPlatformStats();
                logTest(`Platform Stats: ${JSON.stringify(result).substring(0, 100)}...`,
                       result.success ? 'success' : 'error');
            } catch (error) {
                logTest(`Platform Stats error: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            logTest('Testing Login (demo)...', 'info');
            
            // This is a demo - in real app you'd have actual credentials
            try {
                const result = await arexAPI.login('test@example.com', 'password');
                logTest(`Login: ${result.success ? 'Success' : 'Failed'} - ${result.error || ''}`,
                       result.success ? 'success' : 'error');
            } catch (error) {
                logTest(`Login error: ${error.message}`, 'error');
            }
        }
        
        async function loadAgentPayments() {
            logTest('Loading agent payments...', 'info');
            
            const paymentsDiv = document.getElementById('agent-payments');
            paymentsDiv.innerHTML = '<div style="text-align: center; padding: 1rem;">Loading...</div>';
            
            try {
                const result = await arexAPI.getAgentPaymentSummary();
                
                if (result.success && result.payments && result.payments.length > 0) {
                    const paymentsHtml = result.payments.slice(0, 5).map(payment => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin: 8px 0; border-radius: 8px;">
                            <div>
                                <div style="font-weight: bold;">${payment.agentName || 'Agent ' + payment.agentId}</div>
                                <div style="font-size: 12px; color: #666;">${payment.status || 'pending'}</div>
                            </div>
                            <div style="font-weight: bold; color: #1a237e;">
                                KES ${payment.amount ? payment.amount.toLocaleString('en-KE') : '0'}
                            </div>
                        </div>
                    `).join('');
                    
                    paymentsDiv.innerHTML = paymentsHtml;
                    
                    if (result.payments.length > 5) {
                        paymentsDiv.innerHTML += `
                            <div style="text-align: center; padding: 1rem; color: #666; font-size: 12px;">
                                + ${result.payments.length - 5} more payments
                            </div>
                        `;
                    }
                    
                    logTest(`‚úÖ Loaded ${result.payments.length} agent payments`, 'success');
                } else {
                    paymentsDiv.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            No payments data available
                        </div>
                    `;
                    logTest('No payments data returned', 'info');
                }
            } catch (error) {
                paymentsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #F44336;">
                        Error loading payments: ${error.message}
                    </div>
                `;
                logTest(`‚ùå Payments error: ${error.message}`, 'error');
            }
        }
        
        // Make functions available globally
        window.loadFinancialData = loadFinancialData;
        window.checkFunctionStatus = checkFunctionStatus;
        window.testFinancialApi = testFinancialApi;
        window.testAgentPayments = testAgentPayments;
        window.testHealth = testHealth;
        window.testPlatformStats = testPlatformStats;
        window.testLogin = testLogin;
        window.loadAgentPayments = loadAgentPayments;
    </script>
</body>
</html>
